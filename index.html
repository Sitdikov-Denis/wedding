<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Колба голосов — Мальчик vs Девочка</title>
<style>
  :root{
    --bg:#efe2cf; --bg2:#f5eadb; --panel:#ffffff; --border:#e7dcc8;
    --gold:#c7a66a; --gold2:#f3e5c6;
    --text:#3b2b1f; --muted:#8e7f6b;
    --pink:#ff6fae; --blue:#57a9ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:radial-gradient(1300px 700px at 50% 0%, var(--bg2), var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{min-height:100%;padding:12px;display:grid;grid-template-rows:auto auto 1fr;gap:10px}

  /* Верхняя строка */
  header{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
  .pill{padding:8px 12px;border-radius:999px;background:#fff8ee;border:1px solid #dfcfb3;
        box-shadow:0 2px 8px #0000000d,inset 0 1px 0 #ffffffa0;font-weight:900;letter-spacing:.4px}
  .pill .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
  .pill.b .dot{background:var(--blue)} .pill.p .dot{background:var(--pink)}
  .muted{color:var(--muted)}

  /* Кнопки */
  .controls{display:flex;justify-content:flex-end;gap:10px}
  .btn{padding:10px 16px;border-radius:14px;border:1px solid #dfcfb3;background:#fff8ee;
       font-weight:900;cursor:pointer;box-shadow:0 8px 22px #00000014,inset 0 1px 0 #ffffffe0}
  .btn:active{transform:translateY(1px)}
  .hidden{display:none !important}

  /* Сцена */
  .stage{display:grid;grid-template-columns:minmax(140px,16vw) 1fr minmax(140px,16vw);gap:14px;align-items:center}
  .counter{display:flex;flex-direction:column;align-items:center;gap:6px}
  .label{padding:6px 12px;border:1px solid #dfcfb3;border-radius:14px;background:#fff8ee;font-weight:900;letter-spacing:.6px}
  .value{font-size:clamp(48px,8vw,140px);line-height:1;font-weight:1000;text-shadow:0 6px 18px #00000022}

  .canvasWrap{
    position:relative;min-height:64vh;display:grid;place-items:center;overflow:hidden;
    border-radius:26px;background:radial-gradient(1400px 700px at 50% -10%, #ffffff, #dadada);
    border:1px solid var(--border);box-shadow:0 18px 50px #00000025, inset 0 1px 0 #ffffffcc;
    padding:8px;
  }
  canvas{width:100%;height:70vh;display:block}

  /* Финальный оверлей */
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
           background:radial-gradient(700px 400px at 50% 40%, #ffffff80, #0000);
           opacity:0;pointer-events:none;transition:opacity .5s ease}
  .overlay.show{opacity:1}
  .card{padding:26px 34px;border-radius:22px;background:#fff8eecc;border:1px solid #e6d6b8;
        box-shadow:0 20px 80px #00000040;text-align:center}
  .card h1{margin:0 0 6px;font-size:clamp(26px,4vw,48px)}
  .card p{margin:0;color:var(--muted);font-size:clamp(16px,2vw,20px)}
</style>
</head>
<body>
<div class="wrap">

  <header id="topbar">
    <span class="pill b"><span class="dot"></span>Мальчик: <span id="cntBoySmall">0</span></span>
    <span class="pill p"><span class="dot"></span>Девочка: <span id="cntGirlSmall">0</span></span>
    <span class="pill">Итого: <span id="cntTotal">0</span></span>
    <span class="pill muted" id="scaleInfo">1 шарик = 1 голос</span>
  </header>

  <div class="controls" id="ctrl">
    <button class="btn" id="fsBtn">Полный экран</button>
    <button class="btn" id="goBtn">Поехали</button>
  </div>

  <section class="stage">
    <aside class="counter">
      <div class="label">МАЛЬЧИК</div>
      <div class="value" id="cntBoyBig">0</div>
    </aside>

    <div class="canvasWrap">
      <canvas id="scene"></canvas>

      <!-- победитель -->
      <div class="overlay" id="overlay">
        <div class="card">
          <h1 id="winTitle">Победитель</h1>
          <p id="winSub">Все голоса учтены</p>
        </div>
      </div>
    </div>

    <aside class="counter">
      <div class="label">ДЕВОЧКА</div>
      <div class="value" id="cntGirlBig">0</div>
    </aside>
  </section>
</div>

<script>
/* ======= ВСТАВЬТЕ ВАШУ CSV-ССЫЛКУ ======= */
const SOURCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScUpoDoG9BZOfEGgNdecule2fc6mVQBYVCMB5JjksJLZD2Pw48jb9G1wqWqmuuBM2XS2p3lxBm3Dj8/pub?gid=1307519951&single=true&output=csv";

/* ======= Настройки ======= */
const POLL_MS = 2000;          // частота опроса таблицы
const DROP_INTERVAL = 1000;    // шаг падения шариков, мс
const CAPACITY = 70;           // максимум шариков в колбе (визуально)

/* ======= Элементы ======= */
const canvas = document.getElementById('scene');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById('overlay');
const winTitle = document.getElementById('winTitle');
const winSub = document.getElementById('winSub');

const cntBoySmall = document.getElementById('cntBoySmall');
const cntGirlSmall= document.getElementById('cntGirlSmall');
const cntBoyBig   = document.getElementById('cntBoyBig');
const cntGirlBig  = document.getElementById('cntGirlBig');
const cntTotalEl  = document.getElementById('cntTotal');
const scaleInfo   = document.getElementById('scaleInfo');

const fsBtn = document.getElementById('fsBtn');
const goBtn = document.getElementById('goBtn');
const topbar = document.getElementById('topbar');
const ctrl = document.getElementById('ctrl');

/* ======= Геометрия колбы ======= */
let jar = { x:0, y:0, w:0, h:0, neckW:0, neckH:0, wall:0 };
function onResize(){
  const rect = canvas.parentElement.getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio||1);
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height= Math.floor(rect.height* dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // ровная симметричная баночка
  jar.w = rect.width * 0.36;             // ШИРЕ, чтобы не выглядела «узкой»
  jar.h = rect.height* 0.76;
  jar.x = rect.width/2;
  jar.y = rect.height*0.92;
  jar.neckW = Math.max(140, Math.min(220, rect.width*0.12));
  jar.neckH = Math.max(60, Math.min(90,  rect.height*0.08));
  jar.wall  = Math.max(12, Math.min(22,  rect.width*0.012));
}
addEventListener('resize', onResize);

/* Внутренний прямоугольник, куда укладываются шарики */
function jarInnerRect(){
  const r = Math.min(90, jar.w*0.16); // скругления
  return {
    left:   jar.x - jar.w/2 + jar.wall*1.3 + r*0.04,
    right:  jar.x + jar.w/2 - jar.wall*1.3 - r*0.04,
    top:    jar.y - jar.h + jar.neckH + jar.wall*1.2 + r*0.12,
    bottom: jar.y - jar.wall*1.2 - r*0.50
  };
}

/* Рисуем банку: аккуратный контур и блики */
function drawJar(){
  const {x,y,w,h,neckW,neckH,wall} = jar;
  const r = Math.min(90, w*0.16);

  // фон-ореол
  const glow = ctx.createRadialGradient(x, y-h*0.6, 40, x, y-h*0.6, Math.max(w,h));
  glow.addColorStop(0,'rgba(255,255,255,0.12)');
  glow.addColorStop(1,'rgba(255,255,255,0)');
  ctx.fillStyle = glow; ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(x - w/2, y - h);

  // стекло (заливка)
  ctx.beginPath();
  ctx.moveTo(w/2 - neckW/2, 0);
  ctx.lineTo(w/2 - neckW/2, neckH);
  ctx.lineTo(w - r, neckH);
  ctx.quadraticCurveTo(w, neckH, w, neckH + r);
  ctx.lineTo(w, h - r);
  ctx.quadraticCurveTo(w, h, w - r, h);
  ctx.lineTo(r, h);
  ctx.quadraticCurveTo(0, h, 0, h - r);
  ctx.lineTo(0, neckH + r);
  ctx.quadraticCurveTo(0, neckH, r, neckH);
  ctx.lineTo(w/2 + neckW/2, neckH);
  ctx.lineTo(w/2 + neckW/2, 0);
  ctx.closePath();

  // внутренний мягкий градиент «стекла»
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, 'rgba(255,255,255,0.55)');
  g.addColorStop(.2,'rgba(255,255,255,0.32)');
  g.addColorStop(.6,'rgba(255,255,255,0.18)');
  g.addColorStop(1, 'rgba(255,255,255,0.28)');
  ctx.fillStyle = g; ctx.fill();

  // золотой кант
  ctx.lineWidth = wall;
  const stroke = ctx.createLinearGradient(0,neckH,0,neckH+wall*2);
  stroke.addColorStop(0, '#d8bf88');
  stroke.addColorStop(1, '#b7904d');
  ctx.strokeStyle = stroke; ctx.stroke();

  // золотое кольцо сверху
  ctx.beginPath();
  ctx.ellipse(w/2, 0, neckW/2, neckW/3.2, 0, 0, Math.PI*2);
  ctx.lineWidth = wall*0.9;
  const ring = ctx.createLinearGradient(0,-wall,0,wall);
  ring.addColorStop(0, '#f6e4b8');
  ring.addColorStop(1, '#c7a66a');
  ctx.strokeStyle = ring; ctx.stroke();

  // стеклянный бликовый штрих справа
  ctx.beginPath();
  ctx.moveTo(w*0.86, neckH + r*0.2);
  ctx.lineTo(w*0.86, h - r*0.6);
  ctx.lineWidth = wall*0.45;
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.stroke();

  ctx.restore();

  // мраморная «тарелка» под банкой
  const plateR = w*0.55;
  const plateY = y - wall*0.6;
  const grad = ctx.createRadialGradient(x, plateY, 10, x, plateY, plateR);
  grad.addColorStop(0,'#fff7ec');
  grad.addColorStop(1,'#eadfce');
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.ellipse(x, plateY, plateR, plateR*0.35, 0, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = '#d7c19d'; ctx.lineWidth = 2; ctx.stroke();
}

/* Позиции и радиус шариков — так, чтобы красиво и почти до верха */
function layoutPositions(total){
  const inner = jarInnerRect();
  const width = inner.right - inner.left;
  const height= inner.bottom - inner.top;

  const need = Math.min(total, CAPACITY);
  const targetFill = 0.92;

  // подберём радиус так, чтобы влезло по высоте и ширине
  let cols = Math.max(8, Math.floor(width / 30));
  let r = Math.floor(width / (cols*2 + 2));
  let step = r*2 + 4;

  // если по высоте не помещается — уменьшаем радиус
  let rows = Math.ceil(need / cols);
  const maxH = height * targetFill;
  if (rows * step > maxH){
    r = Math.floor((maxH / rows - 4)/2);
    r = Math.max(8, r);
    step = r*2 + 4;
    cols = Math.max(1, Math.floor(width / step));
    rows = Math.ceil(need / cols);
  }

  const arr = [];
  let row = 0, col = 0;
  for (let i=0;i<need;i++){
    const px = inner.left + (col + 0.5)*step;
    const py = inner.bottom - (row + 0.5)*step;
    arr.push({x:px, y:py, r});
    col++; if (col >= cols){ col=0; row++; }
  }
  return arr;
}

/* Шарики и анимация */
let balls = [];       // {color,x,y,tx,ty,r,t0,dur,landed}
let serverSeq = [];   // ['boy','girl',...]
let animatedN = 0;
let score = {boy:0, girl:0};
let started = false;
let finishShownFor = -1;

function animateNewBalls(slice){
  if (!slice.length) return;
  const positions = layoutPositions(animatedN + slice.length);

  for (let i=0;i<slice.length;i++){
    const idx = animatedN + i;
    const p = positions[Math.min(positions.length-1, idx)];
    const neck = jarInnerRect();
    const sx = (jar.x - jar.neckW/2) + Math.random()*jar.neckW;
    const sy = neck.top - (80 + Math.random()*120);
    balls.push({
      color: slice[i], x:sx, y:sy, tx:p.x, ty:p.y, r:p.r,
      t0: performance.now() + i*DROP_INTERVAL, dur: Math.max(600, DROP_INTERVAL*0.9), landed:false
    });
  }
  animatedN += slice.length;
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  drawJar();

  const inner = jarInnerRect();
  const now = performance.now();
  for (const b of balls){
    const t = Math.max(0, Math.min(1, (now - b.t0)/b.dur));
    const k = 1 - Math.pow(1 - t, 3); // easeOutCubic
    const x = b.x + (b.tx - b.x)*k;
    const y = b.y + (b.ty - b.y)*k;

    // клип по внутреннему объёму банки
    ctx.save();
    ctx.beginPath();
    ctx.rect(inner.left, inner.top, inner.right-inner.left, inner.bottom-inner.top);
    ctx.clip();

    ctx.beginPath(); ctx.arc(x, y, b.r, 0, Math.PI*2);
    const col = (b.color==='girl') ? getComputedStyle(document.documentElement).getPropertyValue('--pink')
                                   : getComputedStyle(document.documentElement).getPropertyValue('--blue');
    ctx.fillStyle = col;
    ctx.shadowColor = col; ctx.shadowBlur = 12; ctx.fill();

    // блик на шарике
    ctx.beginPath();
    ctx.arc(x - b.r*0.35, y - b.r*0.35, b.r*0.38, 0, Math.PI*2);
    const hl = ctx.createRadialGradient(x - b.r*0.35, y - b.r*0.35, 1, x - b.r*0.35, y - b.r*0.35, b.r*0.38);
    hl.addColorStop(0,'rgba(255,255,255,0.9)');
    hl.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle = hl; ctx.fill();

    ctx.restore();

    if (t>=1 && !b.landed){
      b.landed = true;
      if (b.color==='boy') score.boy++; else score.girl++;
      updateScoreUI();
      checkFinish();
    }
  }
  requestAnimationFrame(render);
}

/* UI */
function updateScoreUI(){
  cntBoySmall.textContent = score.boy; cntBoyBig.textContent = score.boy;
  cntGirlSmall.textContent= score.girl; cntGirlBig.textContent= score.girl;
  cntTotalEl.textContent  = score.boy + score.girl;
  const scale = Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent = `1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
}
function pluralRu(n, forms){ const n10=n%10,n100=n%100; if(n10===1&&n100!==11)return forms[0]; if(n10>=2&&n10<=4&&(n100<10||n100>=20))return forms[1]; return forms[2]; }

function showWinner(title, sub){ winTitle.textContent=title; winSub.textContent=sub; overlay.classList.add('show'); }
function hideWinner(){ overlay.classList.remove('show'); }

function checkFinish(){
  if(!started) return;
  const total = score.boy + score.girl;
  if (total < serverSeq.length) return;
  if (finishShownFor === serverSeq.length) return;
  if (score.boy > score.girl) showWinner('Победил МАЛЬЧИК!', 'Поздравляем родителей!');
  else if (score.girl > score.boy) showWinner('Победила ДЕВОЧКА!', 'Поздравляем родителей!');
  else showWinner('Ничья!', 'Вы — идеальная команда ♥');
  finishShownFor = serverSeq.length;
}

/* CSV загрузка */
function normalizeChoice(v){
  const s = (v||"").toLowerCase();
  if (s.includes("маль") || s.includes("boy") || s.includes("голуб")) return "boy";
  if (s.includes("дев")  || s.includes("girl")|| s.includes("розов")) return "girl";
  return "";
}
function parseCsv(text){
  const rows=[]; let row=[], cur="", inQ=false;
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (c=='"'){ if(inQ && n=='"'){cur+='"'; i++;} else inQ=!inQ; }
    else if (c==',' && !inQ){ row.push(cur); cur=""; }
    else if ((c=='\n'||c=='\r') && !inQ){ if(cur!==""||row.length){row.push(cur); rows.push(row); row=[]; cur="";} }
    else { cur+=c; }
  }
  if (cur!==""||row.length){ row.push(cur); rows.push(row); }
  return rows;
}
async function fetchSeq(){
  const url = SOURCE_URL + (SOURCE_URL.includes('?')?'&':'?') + 'nocache=' + Date.now();
  const res = await fetch(url, {cache:'no-store'}).catch(()=>null);
  if (!res || !res.ok) return;
  const text = await res.text();
  const rows = parseCsv(text).filter(r=>r.length>=2);
  const seq = [];
  for (let i=1;i<rows.length;i++){
    const val = (rows[i][1]||"").toString().trim();
    const norm = normalizeChoice(val);
    if (norm) seq.push(norm);
  }
  serverSeq = seq;
  const scale = Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent = `1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
  if (finishShownFor>=0 && (score.boy+score.girl) < serverSeq.length) hideWinner();
}

/* Кнопки */
fsBtn.onclick = async()=>{
  try{ await document.documentElement.requestFullscreen(); }catch(e){}
  fsBtn.classList.add('hidden');             // как просили: спрятать после клика
};
goBtn.onclick = async()=>{
  if (started) return;
  started = true;
  topbar.classList.add('hidden');            // верхняя строка убирается
  ctrl.classList.add('hidden');              // кнопки убираются
  try{ if(!document.fullscreenElement) await document.documentElement.requestFullscreen(); }catch(e){}
  // сброс
  balls.length = 0; score={boy:0,girl:0}; animatedN=0; finishShownFor=-1; hideWinner(); updateScoreUI();
  if (serverSeq.length){
    const first = serverSeq.slice(0, Math.min(serverSeq.length, CAPACITY));
    animateNewBalls(first);
    // «лишние» просто плюсуем к счёту (без визуализации)
    if (serverSeq.length > CAPACITY){
      const extra = serverSeq.slice(CAPACITY);
      extra.forEach((c,i)=>setTimeout(()=>{
        if (c==='boy') score.boy++; else score.girl++;
        updateScoreUI(); checkFinish();
      }, (first.length+i)*DROP_INTERVAL));
    }
  }
};
document.addEventListener('fullscreenchange', ()=>{
  if (!document.fullscreenElement) fsBtn.classList.remove('hidden');
});

/* Старт */
onResize();
requestAnimationFrame(render);
fetchSeq();
setInterval(fetchSeq, POLL_MS);
</script>
</body>
</html>
