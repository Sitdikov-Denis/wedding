<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Колба голосов — Мальчик vs Девочка</title>
<style>
  :root { --pink:#ff6fae; --blue:#57a9ff; --bg:#0b0c12; --panel:#131521; --border:#2a2d3a; --text:#e9ecf3; --muted:#9aa0ad; }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:radial-gradient(1200px 800px at 30% 15%, #1a1d2c, var(--bg));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  .wrap{min-height:100%;padding:16px;display:grid;grid-template-rows:auto auto 1fr;gap:12px}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px;border-radius:16px;background:linear-gradient(180deg,#1b1e2c,#101320);border:1px solid var(--border); transition:opacity .2s ease}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .pill{padding:10px 14px;border-radius:999px;background:#0d1020;border:1px solid #272a38;font-weight:800}
  .pill .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
  .pill.pink .dot{background:var(--pink)} .pill.blue .dot{background:var(--blue)}
  .muted{color:var(--muted)}

  /* Кнопки */
  .cta{width:100%; display:flex; justify-content:center; transition:opacity .2s ease}
  .btn{appearance:none;border:none;cursor:pointer;padding:10px 16px;border-radius:12px;background:#0d1020;border:1px solid #292c3a;color:#e9ecf3;font-weight:700;transition:transform .05s ease}
  .btn:active{transform:translateY(1px)} .btn[disabled]{opacity:.6;cursor:default}
  .btn-go{font-size:20px; padding:14px 28px; border-radius:16px;background:linear-gradient(180deg,#2b2f45,#191c2d);border:1px solid #3a3e55;box-shadow:0 8px 32px rgba(80,100,255,.25), inset 0 0 0 1px rgba(255,255,255,.03)}
  .btn-go .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#57a9ff;margin-right:10px;box-shadow:0 0 12px #57a9ff80}

  /* Сцена */
  .stage{
    display:grid;
    grid-template-columns: minmax(140px, 18vw) 1fr minmax(140px, 18vw);
    gap: 16px; align-items:center;
  }
  .side{
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    background:linear-gradient(180deg,#171a28,#0f1120);
    border:1px solid var(--border); border-radius:20px; padding:16px 10px;
  }
  .side .label{
    display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px; text-transform:uppercase; opacity:.9
  }
  .side .label .dot{width:14px;height:14px;border-radius:50%}
  .side.left  .label .dot{background:var(--blue); box-shadow:0 0 18px #57a9ff80}
  .side.right .label .dot{background:var(--pink); box-shadow:0 0 18px #ff6fae80}
  .side .value{
    font-weight:1000; line-height:1; margin-top:10px;
    font-size: clamp(48px, 8vw, 140px);
    text-shadow: 0 8px 28px rgba(0,0,0,.35);
  }

  .canvasWrap{
    position:relative;
    background:linear-gradient(180deg,#171a28,#0f1120);
    border:1px solid var(--border); border-radius:20px; padding:8px;
    display:grid; place-items:center; min-height:60vh; overflow:hidden;
  }
  canvas{width:100%;height:72vh;display:block}

  /* Финальный оверлей */
  .overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:radial-gradient(800px 500px at 50% 40%, rgba(255,255,255,.08), rgba(0,0,0,.6));
    backdrop-filter: blur(2px);
    opacity:0; pointer-events:none; transition:opacity .6s ease;
  }
  .overlay.show{opacity:1}
  .winnerCard{
    text-align:center; padding:28px 40px; border-radius:24px;
    background:rgba(13,16,32,.72); border:1px solid rgba(90,100,140,.35);
    box-shadow:0 20px 80px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.04);
    animation: pop .5s ease;
  }
  @keyframes pop{ from{ transform:scale(.96); opacity:.5 } to{ transform:scale(1); opacity:1 } }
  .winTitle{
    font-size: clamp(28px, 4vw, 48px); font-weight:1000; letter-spacing:.5px; margin:0 0 6px;
    text-shadow: 0 6px 30px rgba(0,0,0,.55);
  }
  .winSub{
    font-size: clamp(18px, 2.2vw, 24px); color:var(--muted); margin:0;
  }
  .glow{
    position:absolute; inset:auto; width:60vmin; height:60vmin; border-radius:50%;
    filter: blur(40px); opacity:.55; pointer-events:none; transform:translate(-50%,-50%);
    left:50%; top:50%;
  }

  .hidden{display:none !important}
  body.fs .wrap{padding-top:6px}
  body.fs canvas{height:78vh}

  @media (max-width: 900px){
    .stage{grid-template-columns: 1fr}
    .side{display:none}
    canvas{height:65vh}
  }
</style>
</head>
<body>
<div class="wrap">
  <header id="topbar">
    <div class="row" style="gap:16px">
      <div class="pill blue"><span class="dot"></span>Мальчик: <span id="cntBoySmall">0</span></div>
      <div class="pill pink"><span class="dot"></span>Девочка: <span id="cntGirlSmall">0</span></div>
      <div class="pill muted">Итого: <span id="cntTotal">0</span></div>
      <div class="pill muted" id="scaleInfo">1 шарик = 1 голос</div>
    </div>
    <div class="row">
      <button class="btn" onclick="toggleFullscreen()">На весь экран</button>
      <button class="btn" onclick="forceRefresh()">Обновить</button>
    </div>
  </header>

  <div class="cta" id="ctaRow">
    <button id="goBtn" class="btn btn-go" onclick="startShow()">
      <span class="dot"></span>Поехали
    </button>
  </div>

  <section class="stage">
    <aside class="side left">
      <div class="label"><span class="dot"></span>Мальчик</div>
      <div class="value" id="cntBoyBig">0</div>
    </aside>

    <div class="canvasWrap" id="stage">
      <canvas id="scene"></canvas>

      <!-- Конфетти-канва сверху -->
      <canvas id="confetti" class="hidden" style="position:absolute;inset:0;"></canvas>

      <!-- Оверлей победителя -->
      <div id="overlay" class="overlay">
        <div class="glow" id="glow"></div>
        <div class="winnerCard">
          <h1 class="winTitle" id="winTitle">Победитель</h1>
          <p class="winSub" id="winSub">Все голоса учтены</p>
        </div>
      </div>
    </div>

    <aside class="side right">
      <div class="label"><span class="dot"></span>Девочка</div>
      <div class="value" id="cntGirlBig">0</div>
    </aside>
  </section>
</div>

<script>
/* ===== ССЫЛКА НА CSV ВАШЕГО ЛИСТА ===== */
const SOURCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScUpoDoG9BZOfEGgNdecule2fc6mVQBYVCMB5JjksJLZD2Pw48jb9G1wqWqmuuBM2XS2p3lxBm3Dj8/pub?gid=1307519951&single=true&output=csv";

/* ===== Настройки ===== */
const POLL_MS = 2000;
const FALL_DURATION = 1000;
const START_SPACING_MS = 1000;
const CAPACITY = 70;
const MAX_BALLS_DRAWN = CAPACITY;

/* ===== Глобальные ===== */
const canvas = document.getElementById('scene');
const ctx = canvas.getContext('2d');
let jar = { x: 700, y: 820, w: 520, h: 620, neckW: 180, neckH: 70, wall: 16 };

const cntBoySmall = document.getElementById('cntBoySmall');
const cntGirlSmall= document.getElementById('cntGirlSmall');
const cntBoyBig   = document.getElementById('cntBoyBig');
const cntGirlBig  = document.getElementById('cntGirlBig');
const cntTotalEl  = document.getElementById('cntTotal');
const scaleInfo   = document.getElementById('scaleInfo');
const goBtn       = document.getElementById('goBtn');
const topbar      = document.getElementById('topbar');
const ctaRow      = document.getElementById('ctaRow');

const overlay     = document.getElementById('overlay');
const winTitle    = document.getElementById('winTitle');
const winSub      = document.getElementById('winSub');
const glow        = document.getElementById('glow');

let serverSeq = [];   // ['boy','girl', ...]
let animatedN = 0;
let balls = [];
let score = { boy:0, girl:0 };
let started = false;
let finishShownFor = -1; // число голосов, для которых уже показывали финал

/* ========= helpers ========= */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function toggleFullscreen(){ if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{}); }
function jarCornerRadius(){ return Math.min(90, jar.w * 0.16); }

/* ========= resize & jar ========= */
function onResize(){
  const rect = document.querySelector('.canvasWrap').getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height= Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  jar.w = rect.width * 0.38;
  jar.h = rect.height * 0.78;
  jar.x = rect.width / 2;
  jar.y = rect.height * 0.90;
  jar.neckW = clamp(rect.width*0.12, 120, 220);
  jar.neckH = clamp(rect.height*0.07, 50, 90);
  jar.wall  = clamp(rect.width*0.012, 10, 22);

  // конфетти canvas синхронизируем
  sizeConfettiCanvas();
}
addEventListener('resize', onResize);

function drawJar(){
  const {x,y,w,h,neckW,neckH,wall} = jar;
  ctx.save();
  ctx.translate(x - w/2, y - h);
  ctx.lineWidth = wall;
  ctx.strokeStyle = 'rgba(230,235,255,0.9)';
  ctx.fillStyle = 'rgba(255,255,255,0.02)';
  ctx.beginPath();
  const r = jarCornerRadius();
  ctx.moveTo(w/2 - neckW/2, 0);
  ctx.lineTo(w/2 - neckW/2, neckH);
  ctx.lineTo(w - r, neckH);
  ctx.quadraticCurveTo(w, neckH, w, neckH + r);
  ctx.lineTo(w, h - r);
  ctx.quadraticCurveTo(w, h, w - r, h);
  ctx.lineTo(r, h);
  ctx.quadraticCurveTo(0, h, 0, h - r);
  ctx.lineTo(0, neckH + r);
  ctx.quadraticCurveTo(0, neckH, r, neckH);
  ctx.lineTo(w/2 + neckW/2, neckH);
  ctx.lineTo(w/2 + neckW/2, 0);
  ctx.lineTo(w/2 - neckW/2, 0);
  ctx.closePath();
  ctx.fill(); ctx.stroke();
  ctx.restore();
}

function jarInnerRect(){
  const r = jarCornerRadius();
  const {x,y,w,h,neckW,neckH,wall} = jar;
  return {
    left:   x - w/2 + wall*1.2 + r*0.05,
    right:  x + w/2 - wall*1.2 - r*0.05,
    top:    y - h + neckH + wall*1.2 + r*0.15,
    bottom: y - wall*1.2 - r*0.75
  };
}

/* ========= layout ========= */
function layoutPositions(totalBalls){
  const inner = jarInnerRect();
  const width = inner.right - inner.left;
  const height = inner.bottom - inner.top;

  const need = Math.min(totalBalls, CAPACITY);
  const targetFill = 0.90;

  let r = Math.max(8, Math.floor(width / 20));
  let step = r*2 + 4;
  let cols = Math.max(1, Math.floor(width / step));
  let rows = Math.ceil(need / cols);
  const maxH = height * targetFill;

  if (rows * step > maxH) {
    r = Math.floor((maxH / rows - 4) / 2);
    r = Math.max(6, r);
    step = r*2 + 4;
    cols = Math.max(1, Math.floor(width / step));
    rows = Math.ceil(need / cols);
  }

  const positions = [];
  let row = 0, col = 0;
  for (let i=0;i<need;i++){
    const px = inner.left + (col + 0.5)*step;
    const py = inner.bottom - (row + 0.5)*step;
    positions.push({x:px, y:py, r});
    col++; if (col >= cols) { col=0; row++; }
  }
  return positions;
}

/* ========= animation ========= */
function animateNewBalls(seqSlice){
  if (!seqSlice.length) return;

  const spacing = START_SPACING_MS;
  const fallDur = FALL_DURATION;
  const totalAfter = animatedN + seqSlice.length;
  const positions = layoutPositions(totalAfter);

  for (let i=0;i<seqSlice.length;i++){
    const idx = animatedN + i;
    const color = seqSlice[i];

    if (idx < CAPACITY) {
      const p = positions[Math.min(positions.length-1, idx)];
      const neck = jarInnerRect();
      const startX = (jar.x - jar.neckW/2) + Math.random()*jar.neckW;
      const startY = neck.top - (80 + Math.random()*120);

      balls.push({
        color, x:startX, y:startY, tx:p.x, ty:p.y, r:p.r,
        t0: performance.now() + i*spacing, dur: fallDur, landed:false
      });
    } else {
      setTimeout(()=>{
        if (color==='boy') score.boy++; else score.girl++;
        updateScoreUI();
        checkFinish();
      }, i*spacing + fallDur);
    }
  }
  animatedN = Math.min(totalAfter, CAPACITY);
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const grd = ctx.createRadialGradient(jar.x, jar.y-jar.h*0.5, 40, jar.x, jar.y-jar.h*0.5, 800);
  grd.addColorStop(0,'rgba(120,140,255,0.07)'); grd.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle = grd; ctx.fillRect(0,0,canvas.width,canvas.height);

  drawJar();

  const now = performance.now();
  const inner = jarInnerRect();
  for (const b of balls){
    const t = Math.max(0, Math.min(1, (now - b.t0)/b.dur));
    const k = 1 - Math.pow(1 - t, 3);
    const x = b.x + (b.tx - b.x)*k;
    const y = b.y + (b.ty - b.y)*k;

    ctx.save();
    ctx.beginPath();
    ctx.rect(inner.left, inner.top, inner.right-inner.left, inner.bottom-inner.top);
    ctx.clip();

    ctx.beginPath();
    ctx.arc(x, y, b.r, 0, Math.PI*2);
    const col = b.color==='girl' ? getComputedStyle(document.documentElement).getPropertyValue('--pink')
                                 : getComputedStyle(document.documentElement).getPropertyValue('--blue');
    ctx.fillStyle = col; ctx.shadowColor = col; ctx.shadowBlur = 16; ctx.fill();
    ctx.restore();

    if (t>=1 && !b.landed){
      b.landed = true;
      if (b.color==='boy') score.boy++; else score.girl++;
      updateScoreUI();
      checkFinish();
    }
  }
  requestAnimationFrame(render);
}

/* ========= UI & finish ========= */
function updateScoreUI(){
  cntBoySmall.textContent = score.boy; cntGirlSmall.textContent= score.girl;
  cntBoyBig.textContent   = score.boy; cntGirlBig.textContent  = score.girl;
  cntTotalEl.textContent  = score.boy + score.girl;
  const scale = Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent   = `1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
}
function pluralRu(n, forms){
  const n10=n%10,n100=n%100;
  if(n10===1&&n100!==11)return forms[0];
  if(n10>=2&&n10<=4&&(n100<10||n100>=20))return forms[1];
  return forms[2];
}

/* ========= CSV ========= */
function normalizeChoice(v){
  const s = (v||"").toLowerCase();
  if (s.includes("маль") || s.includes("boy") || s.includes("голуб")) return "boy";
  if (s.includes("дев")  || s.includes("girl")|| s.includes("розов")) return "girl";
  return "";
}
function parseCsv(text){
  const rows=[]; let row=[], cur="", inQ=false;
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (c=='"'){ if(inQ && n=='"'){cur+='"'; i++;} else inQ=!inQ; }
    else if (c==',' && !inQ){ row.push(cur); cur=""; }
    else if ((c=='\n'||c=='\r') && !inQ){ if(cur!==""||row.length){row.push(cur); rows.push(row); row=[]; cur="";} }
    else { cur+=c; }
  }
  if (cur!==""||row.length){ row.push(cur); rows.push(row); }
  return rows;
}

/* ========= Загрузка и старт ========= */
async function fetchSeq(){
  const url = SOURCE_URL + (SOURCE_URL.includes('?')?'&':'?') + 'nocache=' + Date.now();
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) return;
  const text = await res.text();

  const rows = parseCsv(text).filter(r => r.length >= 2);
  const seq = [];
  for (let i=1;i<rows.length;i++){
    const val = (rows[i][1]||"").toString().trim();
    const norm = normalizeChoice(val);
    if (norm) seq.push(norm);
  }

  serverSeq = seq;
  const scale = Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent = `1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
  // если уже показывали финал, а ответов стало больше — спрячем финал до следующего завершения
  if (finishShownFor >= 0 && (score.boy + score.girl) < serverSeq.length) hideWinner();
}

async function startShow(){
  if (started) return;
  started = true;

  try { await document.documentElement.requestFullscreen(); } catch(e) {}
  topbar.classList.add('hidden'); ctaRow.classList.add('hidden'); document.body.classList.add('fs');

  balls = []; score = { boy:0, girl:0 }; animatedN = 0; finishShownFor = -1;
  hideWinner(); updateScoreUI();

  if (serverSeq.length){
    const firstBatch = serverSeq.slice(0, CAPACITY);
    animateNewBalls(firstBatch);
    if (serverSeq.length > CAPACITY) {
      let extra = serverSeq.length - CAPACITY;
      for (let i=0;i<extra;i++){
        const color = serverSeq[CAPACITY + i];
        setTimeout(()=>{
          if (color==='boy') score.boy++; else score.girl++;
          updateScoreUI(); checkFinish();
        }, (animatedN + i) * START_SPACING_MS + FALL_DURATION);
      }
    }
  }
}

function forceRefresh(){
  fetchSeq().then(()=>{
    if (started){
      const tail = serverSeq.slice(animatedN);
      if (tail.length) animateNewBalls(tail);
    }
  }).catch(()=>{});
}

/* ========= Финал: показ победителя + конфетти ========= */
function checkFinish(){
  const totalNow = score.boy + score.girl;
  if (!started) return;
  if (serverSeq.length === 0) return;
  if (totalNow < serverSeq.length) return;
  if (finishShownFor === serverSeq.length) return; // уже показывали для этой партии

  const boy = score.boy, girl = score.girl;
  const winner = boy > girl ? 'boy' : (girl > boy ? 'girl' : 'tie');

  if (winner === 'tie'){
    showWinner('Ничья!', 'Вы потрясающая команда ♥', '#9aa0ad');
  } else if (winner === 'boy'){
    showWinner('Победил МАЛЬЧИК!', 'Поздравляем родителей!', getComputedStyle(document.documentElement).getPropertyValue('--blue'));
  } else {
    showWinner('Победила ДЕВОЧКА!', 'Поздравляем родителей!', getComputedStyle(document.documentElement).getPropertyValue('--pink'));
  }
  finishShownFor = serverSeq.length;
}

function showWinner(title, subtitle, color){
  winTitle.textContent = title;
  winSub.textContent = subtitle;
  glow.style.background = color.trim();
  overlay.classList.add('show');
  startConfetti(color);
}
function hideWinner(){
  overlay.classList.remove('show');
  stopConfetti();
}

/* ========= Конфетти (простая реализация) ========= */
const confettiCanvas = document.getElementById('confetti');
const cctx = confettiCanvas.getContext('2d');
let confettiTimer = null;
let confettiParts = [];

function sizeConfettiCanvas(){
  const rect = document.getElementById('stage').getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  confettiCanvas.width = Math.floor(rect.width * dpr);
  confettiCanvas.height= Math.floor(rect.height * dpr);
  cctx.setTransform(dpr,0,0,dpr,0,0);
}

function startConfetti(accent){
  sizeConfettiCanvas();
  confettiCanvas.classList.remove('hidden');
  confettiParts = [];
  const colors = [
    accent.trim(),
    '#ffffff',
    'rgba(255,255,255,.6)',
    accent.replace(')',', .6)').replace('rgb','rgba')
  ];

  const W = confettiCanvas.width, H = confettiCanvas.height;
  const count = 150;

  for (let i=0;i<count;i++){
    confettiParts.push({
      x: Math.random()*W, y: -Math.random()*H*0.3,
      r: 4 + Math.random()*4,
      s: 1 + Math.random()*2,
      a: Math.random()*Math.PI*2,
      v: 30 + Math.random()*70,
      col: colors[i % colors.length]
    });
  }

  let last = performance.now();
  function tick(){
    const now = performance.now();
    const dt = Math.min(0.033, (now-last)/1000); last=now;

    cctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for (const p of confettiParts){
      p.y += p.v * dt; p.x += Math.sin(p.a += dt*5) * 30 * dt;
      cctx.beginPath(); cctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      cctx.fillStyle = p.col; cctx.fill();
    }
    confettiTimer = requestAnimationFrame(tick);
  }
  confettiTimer = requestAnimationFrame(tick);

  // авто-стоп через 8 секунд
  setTimeout(stopConfetti, 8000);
}
function stopConfetti(){
  if (confettiTimer){ cancelAnimationFrame(confettiTimer); confettiTimer = null; }
  confettiCanvas.classList.add('hidden');
}

/* ========= boot ========= */
onResize();
requestAnimationFrame(render);
fetchSeq();
setInterval(fetchSeq, POLL_MS);

document.addEventListener('fullscreenchange', () => {
  if (document.fullscreenElement) document.body.classList.add('fs');
  else document.body.classList.remove('fs');
});
</script>
</body>
</html>
