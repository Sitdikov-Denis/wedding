<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Колба голосов — Мальчик vs Девочка</title>
<style>
  :root{
    --bg:#f5eadd; --bg2:#efe0d0;
    --frame:#caa86e; --frame2:#a8884f;
    --text:#4d3a26; --muted:#8b7a62;
    --pink:#ff7fab; --blue:#65b6ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family: ui-serif, Georgia, "Times New Roman", serif}
  .wrap{min-height:100%;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:16px}

  .frame{
    position:relative; display:inline-flex; align-items:center; justify-content:center;
    padding:12px 18px; min-width:140px; background:#fff9; border-radius:16px;
    color:var(--text); font-weight:800; letter-spacing:.5px; text-transform:uppercase;
    box-shadow:0 0 0 1.5px #fff inset, 0 0 0 4px var(--frame) inset, 0 8px 20px #00000018, 0 1px 0 #ffffffcc inset, 0 -2px 6px #7a623640 inset;
    border:1px solid var(--frame2); backdrop-filter:saturate(1.2) blur(1px);
  }
  .frame.small{font-size:12px; padding:8px 12px; border-radius:14px}
  .frame .dot{width:12px;height:12px;border-radius:50%;display:inline-block;margin-right:8px}
  .frame .dot.blue{background:var(--blue)} .frame .dot.pink{background:var(--pink)}
  .btn{appearance:none;border:none;background:transparent;color:inherit;font:inherit;cursor:pointer}
  .btn:active{transform:translateY(1px)}

  header{display:flex;align-items:center;justify-content:space-between; gap:12px}
  .leftBadges{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .rightButtons{display:flex; gap:10px; align-items:center}

  .stage{
    display:grid; grid-template-columns: minmax(160px, 22vw) 1fr minmax(160px, 22vw);
    gap: 18px; align-items:center;
  }
  .side{display:flex; flex-direction:column; align-items:center; gap:10px}
  .side .frame{font-size:14px}
  .scoreValue{font-size: clamp(52px, 7.5vw, 140px); line-height:1; font-weight:1000; text-shadow: 0 10px 30px #00000018}

  .canvasWrap{
    position:relative; border-radius:26px; padding:26px;
    background: radial-gradient(1200px 700px at 50% 0%, #ffffff66, #ffffff10),
                linear-gradient(180deg, #ffffff66, #ffffff1e);
    /* убран верхний внутренний штрих */
    box-shadow: 0 30px 90px #00000012 inset, 0 -12px 28px #cdbba5 inset, 0 24px 60px #00000018;
    min-height:64vh; display:grid; place-items:center; overflow:hidden;
  }
  canvas{width:100%;height:72vh;display:block}

  .overlay{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:radial-gradient(900px 540px at 50% 40%, rgba(255,255,255,.38), rgba(0,0,0,.35)); backdrop-filter: blur(2px); opacity:0; pointer-events:none; transition:opacity .6s ease;}
  .overlay.show{opacity:1}
  .winnerCard{ text-align:center; padding:28px 40px; border-radius:22px; background:rgba(255,255,255,.72); box-shadow: 0 0 0 2px #fff inset, 0 0 0 4px var(--frame) inset, 0 30px 80px #00000028; border:1px solid var(--frame2); }
  .winTitle{font-size: clamp(28px, 4vw, 48px); font-weight:1000; letter-spacing:.5px; margin:0 0 6px}
  .winSub{font-size: clamp(18px, 2.2vw, 24px); color:var(--muted); margin:0}
  .glow{position:absolute; left:50%; top:50%; width:60vmin;height:60vmin;border-radius:50%; filter:blur(40px); opacity:.55; transform:translate(-50%,-50%); pointer-events:none}

  .hidden{display:none !important}
  body.fs canvas{height:78vh}

  @media (max-width: 950px){
    .stage{grid-template-columns: 1fr}
    .side{order:-1}
    .scoreValue{font-size: clamp(42px, 14vw, 110px)}
    canvas{height:65vh}
  }
</style>
</head>
<body>
<div class="wrap">
  <header id="topbar">
    <div class="leftBadges">
      <div class="frame small"><span class="dot blue"></span>Мальчик: <span id="cntBoySmall" style="margin-left:6px">0</span></div>
      <div class="frame small"><span class="dot pink"></span>Девочка: <span id="cntGirlSmall" style="margin-left:6px">0</span></div>
      <div class="frame small" id="scaleInfo">1 шарик = 1 голос</div>
      <div class="frame small">Итого: <span id="cntTotal" style="margin-left:6px">0</span></div>
    </div>
    <div class="rightButtons">
      <button class="btn" id="goBtnTop" onclick="startShow()"><span class="frame">Поехали</span></button>
      <button class="btn" id="fsBtnTop" onclick="enterFullscreen()"><span class="frame">Полный экран</span></button>
    </div>
  </header>

  <section class="stage">
    <aside class="side">
      <div class="frame">Мальчик</div>
      <div class="scoreValue" id="cntBoyBig">0</div>
    </aside>

    <div class="canvasWrap" id="stage">
      <canvas id="scene"></canvas>
      <canvas id="confetti" class="hidden" style="position:absolute;inset:0;"></canvas>

      <div id="overlay" class="overlay">
        <div class="glow" id="glow"></div>
        <div class="winnerCard">
          <h1 class="winTitle" id="winTitle">Победитель</h1>
          <p class="winSub" id="winSub">Все голоса учтены</p>
        </div>
      </div>
    </div>

    <aside class="side">
      <div class="frame">Девочка</div>
      <div class="scoreValue" id="cntGirlBig">0</div>
    </aside>
  </section>
</div>

<script>
/* === ССЫЛКА НА CSV ВАШЕГО ЛИСТА === */
const SOURCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScUpoDoG9BZOfEGgNdecule2fc6mVQBYVCMB5JjksJLZD2Pw48jb9G1wqWqmuuBM2XS2p3lxBm3Dj8/pub?gid=1307519951&single=true&output=csv";

/* === Настройки === */
const POLL_MS = 2000;
const FALL_DURATION = 1000;
const START_SPACING_MS = 1000;
const CAPACITY = 60;
const TARGET_FILL = 0.95;

/* === Глобальные === */
const canvas = document.getElementById('scene');
const ctx = canvas.getContext('2d');
let jar = { x: 700, y: 820, w: 520, h: 620, wall: 14 };

const cntBoySmall = document.getElementById('cntBoySmall');
const cntGirlSmall= document.getElementById('cntGirlSmall');
const cntBoyBig   = document.getElementById('cntBoyBig');
const cntGirlBig  = document.getElementById('cntGirlBig');
const cntTotalEl  = document.getElementById('cntTotal');
const scaleInfo   = document.getElementById('scaleInfo');

const overlay     = document.getElementById('overlay');
const winTitle    = document.getElementById('winTitle');
const winSub      = document.getElementById('winSub');
const glow        = document.getElementById('glow');
const fsBtnTop    = document.getElementById('fsBtnTop');

let serverSeq = [];
let animatedN = 0;
let balls = [];
let score = { boy:0, girl:0 };
let started = false;
let finishShownFor = -1;

/* === Helpers === */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function pluralRu(n, forms){ const n10=n%10,n100=n%100; if(n10===1&&n100!==11)return forms[0]; if(n10>=2&&n10<=4&&(n100<10||n100>=20))return forms[1]; return forms[2]; }
function jarRadius(){ return Math.max(18, jar.w * 0.08); }

async function enterFullscreen(){ try{ await document.documentElement.requestFullscreen(); }catch{} fsBtnTop?.classList.add('hidden'); }
document.addEventListener('fullscreenchange',()=>{ if(!document.fullscreenElement){ fsBtnTop?.classList.remove('hidden'); } });

/* === Resize === */
function onResize(){
  const rect = document.getElementById('stage').getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height= Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  jar.w = rect.width * 0.34;
  jar.h = rect.height * 0.70;
  jar.x = rect.width / 2;
  jar.y = rect.height * 0.87;
  jar.wall  = clamp(rect.width*0.012, 10, 18);
  sizeConfettiCanvas();
}
addEventListener('resize', onResize);

/* === Стеклянный цилиндр (открыт сверху, без обода и пьедестала) === */
/* === Стеклянный цилиндр (тонкий контур, открытый сверху) === */
function drawJar(){
  const {x,y,w,h} = jar;
  const r = Math.max(12, w*0.1); // радиус нижнего скругления
  const left = x - w/2, top = y - h;

  ctx.save();
  ctx.lineWidth = 3; // тонкий контур
  ctx.strokeStyle = "rgba(180,170,150,0.7)";
  ctx.fillStyle = "rgba(255,255,255,0.05)";

  // контур: открытый сверху, скруглённый снизу
  ctx.beginPath();
  ctx.moveTo(left, top);
  ctx.lineTo(left, y-r);                  // левая стенка
  ctx.quadraticCurveTo(left, y, left+r, y); // левое нижнее скругление
  ctx.lineTo(left+w-r, y);                  // низ
  ctx.quadraticCurveTo(left+w, y, left+w, y-r); // правое нижнее скругление
  ctx.lineTo(left+w, top);                // правая стенка
  ctx.stroke();

  // лёгкие блики слева
  ctx.globalAlpha = .2;
  ctx.fillStyle = "#fff";
  ctx.fillRect(left+8, top+20, 6, h-40);
  ctx.globalAlpha = .08;
  ctx.fillRect(left+20, top+40, 4, h-60);
  ctx.globalAlpha = 1;
  ctx.restore();
}


function jarInnerRect(){
  const {x,y,w,h,wall} = jar;
  return {
    left:   x - w/2 + wall*1.2,
    right:  x + w/2 - wall*1.2,
    top:    y - h + wall*1.2,   // открыто сверху: начинать почти от верха
    bottom: y - wall*0.9
  };
}

/* === Раскладка === */
function layoutPositions(totalBalls){
  const inner = jarInnerRect();
  const W = inner.right - inner.left;
  const H = inner.bottom - inner.top;
  const need = Math.min(totalBalls, CAPACITY);
  if (need<=0) return[];

  const pad = 6;
  const fillH = H*TARGET_FILL;
  let cols = Math.max(1, Math.round(Math.sqrt(need*(W/fillH))));
  cols = Math.min(need, cols);
  let rows = Math.ceil(need/cols);

  let r = Math.floor(Math.max(10, Math.min((W/cols - pad)/2, (fillH/rows - pad)/2)));
  while ((rows*(2*r+pad))>fillH && cols<need){
    cols++; rows = Math.ceil(need/cols);
    r = Math.floor(Math.max(10, Math.min((W/cols - pad)/2, (fillH/rows - pad)/2)));
  }

  const stepX = 2*r+pad, stepY = 2*r+pad;
  const offsetX = (W - cols*stepX)/2;

  const positions=[];
  let row=0,col=0;
  for (let i=0;i<need;i++){
    const x = inner.left + offsetX + (col+0.5)*stepX;
    const y = inner.bottom - (row+0.5)*stepY;
    positions.push({x,y,r}); col++; if(col>=cols){col=0; row++;}
  }
  return positions;
}

/* === Анимация === */
function animateNewBalls(seqSlice){
  if (!seqSlice.length) return;
  const spacing = START_SPACING_MS;
  const fallDur = FALL_DURATION;
  const totalAfter = animatedN + seqSlice.length;
  const positions = layoutPositions(totalAfter);

  for (let i=0;i<seqSlice.length;i++){
    const idx = animatedN + i;
    const color = seqSlice[i];
    if (idx < CAPACITY){
      const p = positions[Math.min(positions.length-1, idx)];
      const inner = jarInnerRect();
      const startX = inner.left + Math.random()*(inner.right - inner.left); // роняем из «открытого» верха
      const startY = inner.top - (60 + Math.random()*80);
      balls.push({ color, x:startX, y:startY, tx:p.x, ty:p.y, r:p.r, t0: performance.now() + i*spacing, dur: fallDur, landed:false });
    } else {
      setTimeout(()=>{ if (color==='boy') score.boy++; else score.girl++; updateScoreUI(); checkFinish(); }, i*spacing + fallDur);
    }
  }
  animatedN = Math.min(totalAfter, CAPACITY);
}

/* Глянцевый шар */
function drawGlossyBall(x,y,r,colorVar){
  const g = ctx.createRadialGradient(x-r*0.45, y-r*0.55, r*0.2, x, y, r);
  const c = getComputedStyle(document.documentElement).getPropertyValue(colorVar).trim();
  const base = c || (colorVar==='--pink' ? '#ff7fab' : '#65b6ff');
  g.addColorStop(0, '#ffffff');
  g.addColorStop(0.12, base);
  g.addColorStop(1, shade(base, -18));
  ctx.fillStyle = g;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

  ctx.save();
  ctx.globalAlpha = 0.75;
  ctx.fillStyle = 'rgba(255,255,255,.9)';
  ctx.beginPath(); ctx.ellipse(x-r*0.35, y-r*0.45, r*0.35, r*0.22, -0.6, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha = 0.35;
  ctx.beginPath(); ctx.ellipse(x+r*0.20, y+r*0.25, r*0.25, r*0.18, -0.4, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}
function shade(hex, amt){
  const m = hex.match(/#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i);
  if(!m) return hex; const f=v=>Math.max(0,Math.min(255,parseInt(v,16)+amt));
  return `#${f(m[1]).toString(16).padStart(2,'0')}${f(m[2]).toString(16).padStart(2,'0')}${f(m[3]).toString(16).padStart(2,'0')}`;
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawJar();

  const now = performance.now();
  const inner = jarInnerRect();
  ctx.save(); ctx.beginPath(); ctx.rect(inner.left, inner.top, inner.right-inner.left, inner.bottom-inner.top); ctx.clip();

  for (const b of balls){
    const t = Math.max(0, Math.min(1, (now - b.t0)/b.dur));
    const k = 1 - Math.pow(1 - t, 3);
    const x = b.x + (b.tx - b.x)*k;
    const y = b.y + (b.ty - b.y)*k;
    drawGlossyBall(x,y,b.r, b.color==='girl'?'--pink':'--blue');

    if (t>=1 && !b.landed){
      b.landed = true;
      if (b.color==='boy') score.boy++; else score.girl++;
      updateScoreUI(); checkFinish();
    }
  }
  ctx.restore();
  requestAnimationFrame(render);
}

/* === UI & Finish === */
function updateScoreUI(){
  cntBoySmall.textContent = score.boy; cntGirlSmall.textContent= score.girl;
  cntBoyBig.textContent   = score.boy; cntGirlBig.textContent  = score.girl;
  cntTotalEl.textContent  = score.boy + score.girl;
  const scale = Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent   = `1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
}
function checkFinish(){
  const totalNow = score.boy + score.girl;
  if (!started || serverSeq.length===0 || totalNow < serverSeq.length) return;
  if (finishShownFor === serverSeq.length) return;
  const winner = score.boy > score.girl ? 'boy' : (score.girl > score.boy ? 'girl' : 'tie');
  if (winner === 'tie'){
    showWinner('Ничья!', 'Вы потрясающая команда ♥', '#9aa0ad');
  } else if (winner === 'boy'){
    showWinner('Победил МАЛЬЧИК!', 'Поздравляем родителей!', getComputedStyle(document.documentElement).getPropertyValue('--blue'));
  } else {
    showWinner('Победила ДЕВОЧКА!', 'Поздравляем родителей!', getComputedStyle(document.documentElement).getPropertyValue('--pink'));
  }
  finishShownFor = serverSeq.length;
}
function showWinner(title, subtitle, color){
  winTitle.textContent = title; winSub.textContent = subtitle;
  glow.style.background = color.trim(); overlay.classList.add('show'); startConfetti(color);
}
function hideWinner(){ overlay.classList.remove('show'); stopConfetti(); }

/* === CSV === */
function normalizeChoice(v){
  const s = (v||"").toLowerCase();
  if (s.includes("маль") || s.includes("boy") || s.includes("голуб")) return "boy";
  if (s.includes("дев")  || s.includes("girl")|| s.includes("розов")) return "girl";
  return "";
}
function parseCsv(text){
  const rows=[]; let row=[], cur="", inQ=false;
  for (let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if (c=='"'){ if(inQ && n=='"'){cur+='"'; i++;} else inQ=!inQ; }
    else if (c==',' && !inQ){ row.push(cur); cur=""; }
    else if ((c=='\n'||c=='\r') && !inQ){ if(cur!==""||row.length){row.push(cur); rows.push(row); row=[]; cur="";} }
    else { cur+=c; }
  }
  if (cur!==""||row.length){ row.push(cur); rows.push(row); }
  return rows;
}
async function fetchSeq(){
  const url = SOURCE_URL + (SOURCE_URL.includes('?')?'&':'?') + 'nocache=' + Date.now();
  const res = await fetch(url, {cache:'no-store'}); if (!res.ok) return;
  const text = await res.text();
  const rows = parseCsv(text).filter(r => r.length >= 2);
  const seq = [];
  for (let i=1;i<rows.length;i++){
    const val = (rows[i][1]||"").toString().trim();
    const norm = normalizeChoice(val);
    if (norm) seq.push(norm);
  }
  serverSeq = seq;
  const scale = Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent = `1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
  if (finishShownFor >= 0 && (score.boy + score.girl) < serverSeq.length) hideWinner();
}
async function startShow(){
  if (started) return; started = true;
  fsBtnTop?.classList.add('hidden');
  balls = []; score = { boy:0, girl:0 }; animatedN = 0; finishShownFor = -1;
  hideWinner(); updateScoreUI();
  if (serverSeq.length){
    const firstBatch = serverSeq.slice(0, CAPACITY);
    animateNewBalls(firstBatch);
    if (serverSeq.length > CAPACITY) {
      let extra = serverSeq.length - CAPACITY;
      for (let i=0;i<extra;i++){
        const color = serverSeq[CAPACITY + i];
        setTimeout(()=>{ if (color==='boy') score.boy++; else score.girl++; updateScoreUI(); checkFinish(); },
          (animatedN + i) * START_SPACING_MS + FALL_DURATION);
      }
    }
  }
}
function forceRefresh(){
  fetchSeq().then(()=>{
    if (started){
      const tail = serverSeq.slice(animatedN);
      if (tail.length) animateNewBalls(tail);
    }
  }).catch(()=>{});
}

/* === Конфетти === */
const confettiCanvas = document.getElementById('confetti');
const cctx = confettiCanvas.getContext('2d');
let confettiTimer = null;
let confettiParts = [];
function sizeConfettiCanvas(){
  const rect = document.getElementById('stage').getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio || 1);
  confettiCanvas.width = Math.floor(rect.width * dpr);
  confettiCanvas.height= Math.floor(rect.height * dpr);
  cctx.setTransform(dpr,0,0,dpr,0,0);
}
function startConfetti(accent){
  sizeConfettiCanvas();
  confettiCanvas.classList.remove('hidden');
  confettiParts = [];
  const colors = [accent.trim(), '#ffffff', 'rgba(255,255,255,.6)'];
  const W = confettiCanvas.width, H = confettiCanvas.height;
  const count = 140;
  for (let i=0;i<count;i++){
    confettiParts.push({ x:Math.random()*W, y:-Math.random()*H*0.3, r:4+Math.random()*4,
      a:Math.random()*Math.PI*2, v:30+Math.random()*70, col:colors[i%colors.length] });
  }
  let last = performance.now();
  function tick(){
    const now = performance.now(); const dt = Math.min(0.033, (now-last)/1000); last=now;
    cctx.clearRect(0,0,W,H);
    for (const p of confettiParts){
      p.y += p.v*dt; p.x += Math.sin(p.a += dt*5) * 30 * dt;
      cctx.beginPath(); cctx.arc(p.x,p.y,p.r,0,Math.PI*2); cctx.fillStyle=p.col; cctx.fill();
    }
    confettiTimer = requestAnimationFrame(tick);
  }
  confettiTimer = requestAnimationFrame(tick);
  setTimeout(stopConfetti, 8000);
}
function stopConfetti(){ if (confettiTimer){ cancelAnimationFrame(confettiTimer); confettiTimer=null; } confettiCanvas.classList.add('hidden'); }

/* Boot */
onResize();
requestAnimationFrame(render);
fetchSeq();
setInterval(fetchSeq, POLL_MS);
</script>
</body>
</html>
