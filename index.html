<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Колба голосов — классический стиль</title>
<style>
  :root{
    --bg:#efe2cf; --bg2:#f7ecdb;
    --panel:#dbc8a6;
    --gold1:#f7e8c9; --gold2:#cea86e; --gold3:#8c6c3a;
    --text:#4c3a27; --muted:#8e7c66;
    --pink:#ff8fb9; --blue:#6ab8ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--text);font-family:"Libre Baskerville", ui-serif, Georgia, "Times New Roman", serif}
  .wrap{min-height:100%;padding:18px;display:grid;grid-template-rows:auto 1fr;gap:16px;position:relative}

  /* тонкие линии панелей стены */
  .wallLine{position:fixed;top:0;bottom:0;width:1px;background:linear-gradient(var(--panel),#d9c8a7);opacity:.5;pointer-events:none}
  .wallLine.l{left:12vw} .wallLine.r{right:12vw}

  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .plaque{
    display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;
    background:#fffefacc;border:1px solid var(--gold3);
    box-shadow:0 0 0 1.2px #fff inset,0 0 0 3px var(--gold2) inset,0 8px 18px #0002;
    font-weight:800;letter-spacing:.5px;text-transform:uppercase;font-size:12px;
  }
  .dot{width:10px;height:10px;border-radius:50%}
  .pink{background:var(--pink)} .blue{background:var(--blue)}

  .actions{display:flex;gap:10px}
  .btn{appearance:none;border:none;background:transparent;font:inherit;color:inherit;cursor:pointer}
  .btn:active{transform:translateY(1px)}
  .btn .plaque{font-size:14px;padding:10px 16px;border-radius:16px}

  .stage{display:grid;grid-template-columns:minmax(160px,20vw) 1fr minmax(160px,20vw);gap:20px;align-items:center;padding:0 2vw}
  .side{display:flex;flex-direction:column;align-items:center;gap:10px}
  .score{font-size:clamp(60px,8vw,160px);line-height:1;font-weight:1000;text-shadow:0 10px 28px #0002}

  .canvasWrap{
    position:relative;border-radius:26px;padding:28px;overflow:hidden;min-height:66vh;
    background:
      radial-gradient(1400px 800px at 50% 10%, #ffffffb0, #ffffff20),
      linear-gradient(180deg, #fffaf0, #efe0c8);
    box-shadow:0 34px 86px #0000001c inset, 0 8px 0 #ffffffe0 inset, 0 -12px 28px #cfbea6 inset, 0 24px 64px #00000022;
    display:grid;place-items:center;
  }
  canvas{width:100%;height:72vh;display:block}

  /* победитель */
  .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(900px 540px at 50% 40%, #ffffff60, #00000044);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .6s}
  .overlay.show{opacity:1}
  .winnerCard{padding:26px 34px;border-radius:20px;background:#fffffff0;border:1px solid var(--gold3);box-shadow:0 0 0 2px #fff inset,0 0 0 4px var(--gold2) inset,0 26px 70px #0003;text-align:center}
  .winTitle{margin:0 0 6px;font-size:clamp(26px,4vw,46px);font-weight:1000}
  .winSub{margin:0;color:var(--muted);font-size:clamp(16px,2.2vw,22px)}
  .glow{position:absolute;left:50%;top:50%;width:58vmin;height:58vmin;border-radius:50%;filter:blur(38px);opacity:.55;transform:translate(-50%,-50%);pointer-events:none}

  .hidden{display:none!important}
  @media (max-width: 960px){
    .stage{grid-template-columns:1fr}
    .side{order:-1}
    canvas{height:64vh}
  }
</style>
</head>
<body>
<div class="wallLine l"></div><div class="wallLine r"></div>

<div class="wrap">
  <header>
    <div class="badges">
      <div class="plaque"><span class="dot blue"></span>Мальчик: <span id="cntBoySmall">0</span></div>
      <div class="plaque"><span class="dot pink"></span>Девочка: <span id="cntGirlSmall">0</span></div>
      <div class="plaque" id="scaleInfo">1 шарик = 1 голос</div>
      <div class="plaque">Итого: <span id="cntTotal">0</span></div>
    </div>
    <div class="actions">
      <button class="btn" id="goBtn" onclick="startShow()"><span class="plaque">Поехали</span></button>
      <button class="btn" id="fsBtn" onclick="enterFullscreen()"><span class="plaque">Полный экран</span></button>
    </div>
  </header>

  <section class="stage">
    <aside class="side">
      <div class="plaque">Мальчик</div>
      <div class="score" id="cntBoyBig">0</div>
    </aside>

    <div class="canvasWrap" id="stage">
      <canvas id="scene"></canvas>
      <canvas id="confetti" class="hidden" style="position:absolute;inset:0;"></canvas>

      <div id="overlay" class="overlay">
        <div class="glow" id="glow"></div>
        <div class="winnerCard">
          <h1 class="winTitle" id="winTitle">Победитель</h1>
          <p class="winSub" id="winSub">Все голоса учтены</p>
        </div>
      </div>
    </div>

    <aside class="side">
      <div class="plaque">Девочка</div>
      <div class="score" id="cntGirlBig">0</div>
    </aside>
  </section>
</div>

<script>
/* ====== ДАННЫЕ (ваш CSV) ====== */
const SOURCE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScUpoDoG9BZOfEGgNdecule2fc6mVQBYVCMB5JjksJLZD2Pw48jb9G1wqWqmuuBM2XS2p3lxBm3Dj8/pub?gid=1307519951&single=true&output=csv";

/* ====== НАСТРОЙКИ ====== */
const POLL_MS = 2000;
const FALL_DURATION = 1000;
const START_SPACING_MS = 1000;
const CAPACITY = 60;
const TARGET_FILL = 0.96;

/* ====== DOM ====== */
const canvas = document.getElementById('scene');
const ctx = canvas.getContext('2d');
let jar = { x: 700, y: 820, w: 520, h: 620, neckW: 240, neckH: 78, wall: 16 };

const cntBoySmall = document.getElementById('cntBoySmall');
const cntGirlSmall= document.getElementById('cntGirlSmall');
const cntBoyBig   = document.getElementById('cntBoyBig');
const cntGirlBig  = document.getElementById('cntGirlBig');
const cntTotalEl  = document.getElementById('cntTotal');
const scaleInfo   = document.getElementById('scaleInfo');
const fsBtn       = document.getElementById('fsBtn');

const overlay     = document.getElementById('overlay');
const winTitle    = document.getElementById('winTitle');
const winSub      = document.getElementById('winSub');
const glow        = document.getElementById('glow');

/* ====== STATE ====== */
let serverSeq = [];
let animatedN = 0;
let balls = [];
let score = { boy:0, girl:0 };
let started = false;
let finishShownFor = -1;

/* ====== HELPERS ====== */
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function pluralRu(n,f){const n10=n%10,n100=n%100; if(n10===1&&n100!==11)return f[0]; if(n10>=2&&n10<=4&&(n100<10||n100>=20))return f[1]; return f[2];}
async function enterFullscreen(){ try{ await document.documentElement.requestFullscreen(); }catch{} fsBtn?.classList.add('hidden'); }
document.addEventListener('fullscreenchange',()=>{ if(!document.fullscreenElement){ fsBtn?.classList.remove('hidden'); } });

/* ====== GEOMETRY ====== */
function onResize(){
  const rect = document.getElementById('stage').getBoundingClientRect();
  const dpr = Math.min(2, window.devicePixelRatio||1);
  canvas.width = Math.floor(rect.width*dpr);
  canvas.height= Math.floor(rect.height*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  jar.w = rect.width * 0.36;
  jar.h = rect.height* 0.72;
  jar.x = rect.width/2;
  jar.y = rect.height*0.88;
  jar.neckW = clamp(jar.w*0.46, 170, 300);
  jar.neckH = clamp(rect.height*0.085, 58, 96);
  jar.wall  = clamp(rect.width*0.014, 12, 20);

  sizeConfettiCanvas();
}
addEventListener('resize', onResize);

function drawMarbleBase(x,y,w,h){
  ctx.save();
  ctx.fillStyle='rgba(0,0,0,.15)'; ctx.shadowColor='rgba(0,0,0,.28)'; ctx.shadowBlur=50;
  ctx.beginPath(); ctx.ellipse(x, y+h*0.55, w*0.6, h*0.22, 0, 0, Math.PI*2); ctx.fill();
  ctx.restore();

  const topH=Math.min(90,h*0.14), topY=y+4;
  let g=ctx.createLinearGradient(0,topY-topH*0.2,0,topY+topH*0.95);
  g.addColorStop(0,'#ffffffef'); g.addColorStop(1,'#e8dac9'); ctx.fillStyle=g; ctx.strokeStyle='#cdbba7'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.ellipse(x, topY, w*0.58, topH*0.52, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();

  g=ctx.createLinearGradient(0,topY-topH*0.9,0,topY+topH*0.18);
  g.addColorStop(0,'#fff'); g.addColorStop(1,'#eee0d0'); ctx.fillStyle=g;
  ctx.beginPath(); ctx.ellipse(x, topY-topH*0.42, w*0.48, topH*0.36, 0, 0, Math.PI*2); ctx.fill();
}

function drawJar(){
  const {x,y,w,h,neckW,neckH,wall}=jar;
  drawMarbleBase(x,y,w,h);

  const L = x - w/2, T = y - h;

  // мягкая дымка (объём)
  ctx.save();
  const haze = ctx.createRadialGradient(x, y-h*0.58, 24, x, y-h*0.58, h*0.94);
  haze.addColorStop(0,'rgba(255,255,255,.65)');
  haze.addColorStop(0.55,'rgba(255,255,255,.18)');
  haze.addColorStop(1,'rgba(0,0,0,.03)');
  ctx.fillStyle=haze; ctx.fillRect(L+12,T+12,w-24,h-24);
  ctx.restore();

  // стеклянная колба — симметричный контур
  ctx.save();
  ctx.translate(L,T);
  ctx.lineWidth = wall;
  ctx.strokeStyle = 'rgba(202,168,110,.98)';
  ctx.fillStyle   = 'rgba(255,255,255,.10)';
  ctx.beginPath();

  const b = 0.22;  // «выпуклость» стенок
  ctx.moveTo(w/2 - neckW/2, 0);
  ctx.lineTo(w/2 - neckW/2, neckH);

  // правая стенка
  ctx.bezierCurveTo(
    w* (0.50 + b), neckH * 0.92,
    w* (0.98),     h    * 0.30,
    w* 0.84,       h*0.80
  );
  ctx.quadraticCurveTo(w*0.80, h*0.98, w*0.60, h*1.00);
  ctx.lineTo(w*0.40, h*1.00);
  ctx.quadraticCurveTo(w*0.20, h*0.98, w*0.16, h*0.80);
  // левая стенка (симметрия)
  ctx.bezierCurveTo(
    w* (0.02),     h*0.30,
    w* (0.50 - b), neckH * 0.92,
    w/2 - neckW/2, neckH
  );
  ctx.closePath();
  ctx.fill(); ctx.stroke();

  // золотой ободок
  const gold = ctx.createLinearGradient(0,0,0,wall*2.4);
  gold.addColorStop(0, get('--gold1')); gold.addColorStop(0.5, get('--gold2')); gold.addColorStop(1, get('--gold3'));
  ctx.lineWidth = wall*0.9; ctx.strokeStyle=gold;
  ctx.beginPath(); ctx.ellipse(w/2, 0, neckW/2, wall*1.05, 0, 0, Math.PI*2); ctx.stroke();

  // внутренняя «кромка» горлышка (блик)
  ctx.globalAlpha=.35; ctx.fillStyle='#fff';
  ctx.beginPath(); ctx.ellipse(w/2, wall*0.28, neckW*0.34, wall*0.55, 0, 0, Math.PI*2); ctx.fill();
  ctx.globalAlpha=1;

  // два вертикальных боковых блика
  ctx.globalAlpha=.20; ctx.fillStyle='#fff'; ctx.fillRect(w*0.10, neckH+22, 12, h-neckH-70);
  ctx.globalAlpha=.12; ctx.fillRect(w*0.16, neckH+38, 10, h-neckH-90);
  ctx.globalAlpha=1;

  ctx.restore();
}

function jarInnerRect(){
  const {x,y,w,h,neckW,neckH,wall}=jar;
  return {
    left:   x - w/2 + wall*1.6,
    right:  x + w/2 - wall*1.6,
    top:    y - h + neckH + wall*1.6 + 8,
    bottom: y - wall*1.1
  };
}

/* ====== LAYOUT BALLS ====== */
function layoutPositions(total){
  const inner=jarInnerRect();
  const W=inner.right-inner.left, H=inner.bottom-inner.top;
  const need=Math.min(total, CAPACITY); if(!need) return [];
  const pad=6, fillH=H*TARGET_FILL;
  let cols=Math.max(1, Math.round(Math.sqrt(need*(W/fillH))));
  cols=Math.min(need, cols);
  let rows=Math.ceil(need/cols);
  let rW=(W/cols-pad)/2, rH=(fillH/rows-pad)/2, r=Math.floor(Math.max(12,Math.min(rW,rH)));
  while((rows*(2*r+pad))>fillH && cols<need){ cols++; rows=Math.ceil(need/cols); rW=(W/cols-pad)/2; rH=(fillH/rows-pad)/2; r=Math.floor(Math.max(12,Math.min(rW,rH))); }
  const stepX=2*r+pad, stepY=2*r+pad, offsetX=(W-cols*stepX)/2;
  const pts=[]; let row=0,col=0;
  for(let i=0;i<need;i++){ const x=inner.left+offsetX+(col+.5)*stepX, y=inner.bottom-(row+.5)*stepY; pts.push({x,y,r}); col++; if(col>=cols){col=0; row++;} }
  return pts;
}

/* ====== ANIMATION ====== */
function animateNewBalls(slice){
  if(!slice.length) return;
  const spacing=START_SPACING_MS, fall=FALL_DURATION;
  const totalAfter=animatedN+slice.length;
  const pos=layoutPositions(totalAfter);

  for(let i=0;i<slice.length;i++){
    const idx=animatedN+i, color=slice[i];
    if(idx<CAPACITY){
      const p=pos[Math.min(pos.length-1, idx)];
      const neck=jarInnerRect();
      const sx=(jar.x-jar.neckW/2)+Math.random()*jar.neckW, sy=neck.top-(80+Math.random()*120);
      balls.push({color, x:sx, y:sy, tx:p.x, ty:p.y, r:p.r, t0:performance.now()+i*spacing, dur:fall, landed:false});
    }else{
      setTimeout(()=>{ if(color==='boy')score.boy++; else score.girl++; updateScoreUI(); checkFinish(); }, i*spacing+fall);
    }
  }
  animatedN=Math.min(totalAfter,CAPACITY);
}

function drawGlossyBall(x,y,r,varName){
  const base=get(varName);
  const grad=ctx.createRadialGradient(x-r*.45,y-r*.55,r*.2,x,y,r);
  grad.addColorStop(0,'#fff'); grad.addColorStop(0.16, base); grad.addColorStop(1, shade(base,-18));
  ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

  ctx.save();
  ctx.globalAlpha=.78; ctx.fillStyle='rgba(255,255,255,.95)';
  ctx.beginPath(); ctx.ellipse(x-r*.34,y-r*.46,r*.36,r*.24,-.6,0,Math.PI*2); ctx.fill();
  ctx.globalAlpha=.38; ctx.beginPath(); ctx.ellipse(x+r*.22,y+r*.26,r*.26,r*.18,-.35,0,Math.PI*2); ctx.fill();
  ctx.restore();

  ctx.save(); ctx.beginPath(); ctx.ellipse(x,y+r*.82,r*.95,r*.36,0,0,Math.PI*2);
  const s=ctx.createRadialGradient(x,y+r*.82,1,x,y+r*.82,r*1.12); s.addColorStop(0,'rgba(0,0,0,.2)'); s.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=s; ctx.fill(); ctx.restore();
}
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // общий «ореол»
  const halo=ctx.createRadialGradient(jar.x, jar.y-jar.h*.62, 20, jar.x, jar.y-jar.h*.62, 1000);
  halo.addColorStop(0,'rgba(255,255,255,.70)'); halo.addColorStop(1,'rgba(0,0,0,0)');
  ctx.fillStyle=halo; ctx.fillRect(0,0,canvas.width,canvas.height);

  drawJar();

  const inner=jarInnerRect(), now=performance.now();
  ctx.save(); ctx.beginPath(); ctx.rect(inner.left,inner.top,inner.right-inner.left,inner.bottom-inner.top); ctx.clip();

  for(const b of balls){
    const t=Math.max(0, Math.min(1,(now-b.t0)/b.dur)), k=1-Math.pow(1-t,3);
    const x=b.x+(b.tx-b.x)*k, y=b.y+(b.ty-b.y)*k;
    drawGlossyBall(x,y,b.r, b.color==='girl'?'--pink':'--blue');
    if(t>=1 && !b.landed){ b.landed=true; if(b.color==='boy')score.boy++; else score.girl++; updateScoreUI(); checkFinish(); }
  }
  ctx.restore();

  requestAnimationFrame(render);
}

/* ====== UI / FINISH ====== */
function updateScoreUI(){
  cntBoySmall.textContent=score.boy; cntGirlSmall.textContent=score.girl;
  cntBoyBig.textContent=score.boy;   cntGirlBig.textContent=score.girl;
  cntTotalEl.textContent=score.boy+score.girl;
  const scale=Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent=`1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
}
function checkFinish(){
  const total=score.boy+score.girl;
  if(!started || serverSeq.length===0 || total<serverSeq.length) return;
  if(finishShownFor===serverSeq.length) return;
  const winner=score.boy>score.girl?'boy':(score.girl>score.boy?'girl':'tie');
  if(winner==='tie'){ showWinner('Ничья!', 'Вы потрясающая команда ♥', '#9aa0ad'); }
  else if(winner==='boy'){ showWinner('Победил МАЛЬЧИК!', 'Поздравляем родителей!', get('--blue')); }
  else { showWinner('Победила ДЕВОЧКА!', 'Поздравляем родителей!', get('--pink')); }
  finishShownFor=serverSeq.length;
}
function showWinner(title,sub,color){ winTitle.textContent=title; winSub.textContent=sub; glow.style.background=color.trim(); overlay.classList.add('show'); startConfetti(color); }
function hideWinner(){ overlay.classList.remove('show'); stopConfetti(); }

/* ====== CSV ====== */
function normalizeChoice(v){const s=(v||'').toLowerCase(); if(s.includes('маль')||s.includes('boy')||s.includes('голуб'))return'boy'; if(s.includes('дев')||s.includes('girl')||s.includes('розов'))return'girl'; return'';}
function parseCsv(t){const rows=[]; let row=[],cur="",q=false; for(let i=0;i<t.length;i++){const c=t[i],n=t[i+1]; if(c=='"'){ if(q&&n=='"'){cur+='"';i++;}else q=!q;} else if(c==','&&!q){row.push(cur);cur="";} else if((c=='\n'||c=='\r')&&!q){ if(cur!==""||row.length){row.push(cur);rows.push(row);row=[];cur="";}} else cur+=c;} if(cur!==""||row.length){row.push(cur);rows.push(row);} return rows;}
async function fetchSeq(){
  const url=SOURCE_URL+(SOURCE_URL.includes('?')?'&':'?')+'nocache='+Date.now();
  const res=await fetch(url,{cache:'no-store'}); if(!res.ok) return;
  const text=await res.text(); const rows=parseCsv(text).filter(r=>r.length>=2);
  const seq=[]; for(let i=1;i<rows.length;i++){ const v=(rows[i][1]||"").toString().trim(); const n=normalizeChoice(v); if(n) seq.push(n); }
  serverSeq=seq;
  const scale=Math.max(1, Math.ceil((serverSeq.length||1)/CAPACITY));
  scaleInfo.textContent=`1 шарик = ${scale} голос${pluralRu(scale,['','а','ов'])}`;
  if(finishShownFor>=0 && (score.boy+score.girl)<serverSeq.length) hideWinner();
}

/* ====== CONFETTI ====== */
const cCanvas=document.getElementById('confetti'); const cctx=cCanvas.getContext('2d');
let confettiTimer=null, confettiParts=[];
function sizeConfettiCanvas(){const r=document.getElementById('stage').getBoundingClientRect(); const dpr=Math.min(2,window.devicePixelRatio||1); cCanvas.width=Math.floor(r.width*dpr); cCanvas.height=Math.floor(r.height*dpr); cctx.setTransform(dpr,0,0,dpr,0,0);}
function startConfetti(accent){
  sizeConfettiCanvas(); cCanvas.classList.remove('hidden'); confettiParts=[];
  const cols=[accent.trim(),'#fff','rgba(255,255,255,.6)']; const W=cCanvas.width,H=cCanvas.height; const N=140;
  for(let i=0;i<N;i++){ confettiParts.push({x:Math.random()*W,y:-Math.random()*H*0.3,r:4+Math.random()*4,a:Math.random()*Math.PI*2,v:30+Math.random()*70,col:cols[i%cols.length]}); }
  let last=performance.now();
  function tick(){ const now=performance.now(), dt=Math.min(0.033,(now-last)/1000); last=now; cctx.clearRect(0,0,W,H);
    for(const p of confettiParts){ p.y+=p.v*dt; p.x+=Math.sin(p.a+=dt*5)*30*dt; cctx.beginPath(); cctx.arc(p.x,p.y,p.r,0,Math.PI*2); cctx.fillStyle=p.col; cctx.fill(); }
    confettiTimer=requestAnimationFrame(tick);
  }
  confettiTimer=requestAnimationFrame(tick); setTimeout(stopConfetti,8000);
}
function stopConfetti(){ if(confettiTimer){ cancelAnimationFrame(confettiTimer); confettiTimer=null; } cCanvas.classList.add('hidden'); }

/* ====== UTIL ====== */
function get(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
function shade(hex, amt){ const m=hex.match(/#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/i); if(!m)return hex; const f=v=>Math.max(0,Math.min(255,parseInt(v,16)+amt)); return `#${f(m[1]).toString(16).padStart(2,'0')}${f(m[2]).toString(16).padStart(2,'0')}${f(m[3]).toString(16).padStart(2,'0')}`; }

/* ====== BOOT ====== */
onResize(); requestAnimationFrame(render); fetchSeq(); setInterval(fetchSeq, POLL_MS);

async function startShow(){
  if(started) return; started=true;
  document.getElementById('goBtn')?.classList.add('hidden'); // как просили
  balls=[]; score={boy:0,girl:0}; animatedN=0; finishShownFor=-1; hideWinner(); updateScoreUI();
  if(serverSeq.length){
    const first=serverSeq.slice(0,CAPACITY); animateNewBalls(first);
    if(serverSeq.length>CAPACITY){
      const extra=serverSeq.length-CAPACITY;
      for(let i=0;i<extra;i++){const c=serverSeq[CAPACITY+i]; setTimeout(()=>{ if(c==='boy')score.boy++; else score.girl++; updateScoreUI(); checkFinish(); }, (animatedN+i)*START_SPACING_MS+FALL_DURATION);}
    }
  }
}
</script>
</body>
</html>
